# ESP String Parser é‡æ„è®¡åˆ’

## å·²å®Œæˆä»»åŠ¡ âœ…

### P0: æ–‡æ¡£ä¿®æ­£ï¼ˆå·²å®Œæˆï¼‰
- âœ… README.md - å»é™¤å¤¸å¼ è¡¨è¿°ï¼Œæ·»åŠ æµ‹è¯•ç¯å¢ƒè¯´æ˜
- âœ… CHANGELOG.md - è¡¥å……ç‰ˆæœ¬è®°å½•ï¼Œå»é™¤ emojiï¼Œä½¿ç”¨å®¢è§‚æè¿°
- âœ… ARCHITECTURE.md - ç¡®è®¤å¯è¯»æ€§

### P1: CLI å‡çº§ï¼ˆå·²å®Œæˆï¼‰
- âœ… å‡çº§ CLI ç‰ˆæœ¬å·ä» 0.2.0 åˆ° 0.6.0
- âœ… å°†æ‰€æœ‰ `Plugin::new()` æ›¿æ¢ä¸º `Plugin::load()`ï¼ˆ5 å¤„ï¼‰
- âœ… ç§»é™¤ `#![allow(deprecated)]`
- âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆ49/49ï¼‰

### P2.1: æ‹†åˆ† src/plugin.rsï¼ˆå·²å®Œæˆ - 2025-11-26ï¼‰

**ç›®æ ‡**ï¼šå°† 1264 è¡Œçš„å•ä¸€å¤§æ–‡ä»¶æ‹†åˆ†ä¸ºèŒè´£æ¸…æ™°çš„å­æ¨¡å—

**å®æ–½ç»“æœ**ï¼š
```
src/plugin/
â”œâ”€â”€ mod.rs           # Plugin ç»“æ„ä½“å’Œå…¬å…±æ¥å£ (150 è¡Œ)
â”œâ”€â”€ parser.rs        # åŠ è½½å’Œè§£æé€»è¾‘ (240 è¡Œ)
â”œâ”€â”€ strings.rs       # å­—ç¬¦ä¸²æå– (180 è¡Œ)
â”œâ”€â”€ translate.rs     # ç¿»è¯‘åº”ç”¨ (380 è¡Œ)
â”œâ”€â”€ writer.rs        # æ–‡ä»¶å†™å…¥ (130 è¡Œ)
â”œâ”€â”€ stats.rs         # ç»Ÿè®¡ä¿¡æ¯ (70 è¡Œ)
â””â”€â”€ esl.rs           # ESL FormID é‡ç¼–å· (80 è¡Œ)
```

**éªŒè¯ç»“æœ**ï¼š
- âœ… æ‰€æœ‰ 49 ä¸ªå•å…ƒæµ‹è¯•é€šè¿‡
- âœ… Clippy æ£€æŸ¥é€šè¿‡ï¼ˆä»…å°‘é‡è­¦å‘Šï¼‰
- âœ… å‘åå…¼å®¹ï¼šå…¬å…± API ä¿æŒä¸å˜
- âœ… ä»£ç ç»“æ„æ¸…æ™°ï¼ŒèŒè´£åˆ†æ˜

**é‡æ„æ•ˆæœ**ï¼š
- ä»£ç è¡Œæ•°ï¼š1264 è¡Œ â†’ åˆ†æ•£åˆ° 7 ä¸ªæ–‡ä»¶ï¼ˆå¹³å‡ ~180 è¡Œ/æ–‡ä»¶ï¼‰
- èŒè´£æ¸…æ™°ï¼šæ¯ä¸ªæ¨¡å—è´Ÿè´£ç‰¹å®šåŠŸèƒ½
- æ˜“äºç»´æŠ¤ï¼šç›¸å…³ä»£ç é›†ä¸­åœ¨ä¸€èµ·
- æµ‹è¯•ç¨³å®šï¼šæ‰€æœ‰ç°æœ‰æµ‹è¯•ç»§ç»­å·¥ä½œ

## å¾…å®Œæˆä»»åŠ¡

### P2: ä»£ç æ‹†åˆ†ä¸æ¶æ„ä¼˜åŒ–

#### 2.2 æ‹†åˆ† src/string_file.rs (1118 è¡Œ) âœ… å·²å®Œæˆ - 2025-11-26

**ç›®æ ‡**ï¼šåˆ†ç¦»å­—ç¬¦ä¸²æ–‡ä»¶çš„ä¸åŒèŒè´£

**å®æ–½ç»“æœ**ï¼š
```
src/string_file/
â”œâ”€â”€ mod.rs           # å…¬å…±æ¥å£å’ŒåŸºç¡€ç±»å‹ (95 è¡Œ)
â”œâ”€â”€ file.rs          # StringFile ç»“æ„ä½“å’Œæ–¹æ³• (380 è¡Œ)
â”œâ”€â”€ set.rs           # StringFileSet é›†åˆæ“ä½œ (320 è¡Œ)
â”œâ”€â”€ bsa.rs           # BSA fallback é€»è¾‘ (70 è¡Œ)
â”œâ”€â”€ io.rs            # æ–‡ä»¶åè§£æå·¥å…· (54 è¡Œ)
â””â”€â”€ tests.rs         # æµ‹è¯•æ¨¡å— (271 è¡Œ)
```

**éªŒè¯ç»“æœ**ï¼š
- âœ… æ‰€æœ‰ 49 ä¸ªå•å…ƒæµ‹è¯•é€šè¿‡
- âœ… æ‰€æœ‰ string_file ç›¸å…³æµ‹è¯•é€šè¿‡
- âœ… Clippy æ£€æŸ¥é€šè¿‡ï¼ˆä»…å°‘é‡è­¦å‘Šï¼‰
- âœ… å‘åå…¼å®¹ï¼šå…¬å…± API ä¿æŒä¸å˜
- âœ… ä»£ç ç»“æ„æ¸…æ™°ï¼ŒèŒè´£åˆ†æ˜

**é‡æ„æ•ˆæœ**ï¼š
- ä»£ç è¡Œæ•°ï¼š1119 è¡Œ â†’ åˆ†æ•£åˆ° 6 ä¸ªæ–‡ä»¶ï¼ˆå¹³å‡ ~190 è¡Œ/æ–‡ä»¶ï¼‰
- èŒè´£æ¸…æ™°ï¼šæ¯ä¸ªæ¨¡å—è´Ÿè´£ç‰¹å®šåŠŸèƒ½
- æ˜“äºç»´æŠ¤ï¼šç›¸å…³ä»£ç é›†ä¸­åœ¨ä¸€èµ·
- æµ‹è¯•ç¨³å®šï¼šæ‰€æœ‰ç°æœ‰æµ‹è¯•ç»§ç»­å·¥ä½œ

#### 2.3 æå–å­—ç¬¦ä¸²è·¯ç”±ä¸ºç‹¬ç«‹æ¨¡å— âœ… å·²å®Œæˆ - 2025-11-26

**ç›®æ ‡**ï¼šå°† `data/string_records.json` çš„ä½¿ç”¨é€»è¾‘ç‹¬ç«‹åŒ–

**å®æ–½ç»“æœ**ï¼š
```
src/string_routes/
â”œâ”€â”€ mod.rs           # å…¬å…±æ¥å£å¯¼å‡º
â”œâ”€â”€ router.rs        # StringRouter trait å’Œ DefaultStringRouter å®ç°
â””â”€â”€ data.rs          # åŠ è½½ string_records.json
```

**æ¥å£å®ç°**ï¼š
```rust
pub trait StringRouter: Send + Sync + Debug {
    fn get_string_subrecord_types(&self, record_type: &str) -> Option<&[String]>;
    fn supports_strings(&self, record_type: &str, subrecord_type: &str) -> bool;
}

#[derive(Debug)]
pub struct DefaultStringRouter {
    routes: HashMap<String, Vec<String>>,
}
```

**é›†æˆç»“æœ**ï¼š
- âœ… Plugin æ·»åŠ  `string_router: Arc<dyn StringRouter>` å­—æ®µ
- âœ… ä¿ç•™ `string_records` å­—æ®µç”¨äºå‘åå…¼å®¹ï¼ˆæ ‡è®° deprecatedï¼‰
- âœ… æ›´æ–° `extract_strings` å’Œ `apply_translations` ä½¿ç”¨è·¯ç”±å™¨
- âœ… æ–°å¢ 3 ä¸ªè·¯ç”±å™¨å•å…ƒæµ‹è¯•
- âœ… æ‰€æœ‰ 54 ä¸ªåº“æµ‹è¯•é€šè¿‡
- âœ… Clippy æ£€æŸ¥é€šè¿‡

**é‡æ„æ•ˆæœ**ï¼š
- èŒè´£æ¸…æ™°ï¼šè·¯ç”±é€»è¾‘ç‹¬ç«‹ä¸ºæ¨¡å—
- æ˜“äºæ‰©å±•ï¼šå¯è‡ªå®šä¹‰ StringRouter å®ç°
- å‘åå…¼å®¹ï¼šæ—§ä»£ç ç»§ç»­å·¥ä½œ

#### 2.4 å®ç° IO æŠ½è±¡å±‚æ³¨å…¥ âœ… å·²å®Œæˆ - 2025-11-26

**ç›®æ ‡**ï¼šè®©æ ¸å¿ƒæµç¨‹é€šè¿‡ IO trait è€Œéç›´æ¥ä½¿ç”¨ std::fs

**å®æ–½ç»“æœ**ï¼š

IO trait å·²åœ¨ v0.4.0 ä¸­å®Œå–„ï¼ˆsrc/io/ï¼‰ï¼š
- âœ… EspReader/EspWriter trait
- âœ… StringFileReader/StringFileWriter trait
- âœ… DefaultEspReader/DefaultEspWriter å®ç°

**æ–°å¢æ–¹æ³•**ï¼š
```rust
// Plugin æ·»åŠ  reader æ³¨å…¥æ–¹æ³•
impl Plugin {
    pub fn load_with_reader(
        path: PathBuf,
        reader: &dyn EspReader
    ) -> Result<Self> {
        let raw_data = reader.read(&path)?;
        // è§£æé€»è¾‘...
    }

    // ä¿ç•™åŸæ–¹æ³•ï¼ˆå‘åå…¼å®¹ï¼‰
    pub fn load(path: PathBuf) -> Result<Self> {
        // ä½¿ç”¨ memmap ä¼˜åŒ–çš„é»˜è®¤å®ç°
    }
}

// StringFileSet æ·»åŠ  reader æ³¨å…¥æ–¹æ³•
impl StringFileSet {
    pub fn load_from_directory_with_reader(
        directory: &Path,
        plugin_name: &str,
        language: &str,
        reader: &dyn StringFileReader,
    ) -> Result<Self> {
        // ä½¿ç”¨æ³¨å…¥çš„ reader åŠ è½½æ–‡ä»¶
    }

    // ä¿ç•™åŸæ–¹æ³•ï¼ˆå‘åå…¼å®¹ï¼‰
    pub fn load_from_directory(...) -> Result<Self> {
        // é»˜è®¤å®ç°
    }
}
```

**éªŒè¯ç»“æœ**ï¼š
- âœ… æ‰€æœ‰ 54 ä¸ªåº“æµ‹è¯•é€šè¿‡
- âœ… 9/10 é›†æˆæµ‹è¯•é€šè¿‡ï¼ˆ1ä¸ªæ€§èƒ½æµ‹è¯•è¶…æ—¶ï¼ŒéåŠŸèƒ½é—®é¢˜ï¼‰
- âœ… Clippy æ£€æŸ¥é€šè¿‡
- âœ… å‘åå…¼å®¹ï¼šæ—§ä»£ç æ— éœ€ä¿®æ”¹

**é‡æ„æ•ˆæœ**ï¼š
- ä¾èµ–å€’ç½®ï¼šæ ¸å¿ƒé€»è¾‘ä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°
- æ˜“äºæµ‹è¯•ï¼šå¯æ³¨å…¥ mock reader
- æ˜“äºæ‰©å±•ï¼šå¯å®ç°ç½‘ç»œ IOã€å†…å­˜ IO ç­‰
- å‘åå…¼å®¹ï¼šä¿ç•™ä¾¿æ·æ–¹æ³•

### P3: Workspace ç»“æ„è§„åˆ’

**ç›®æ ‡**ï¼šå°†é¡¹ç›®æ‹†åˆ†ä¸ºå¤šä¸ªç‹¬ç«‹ crateï¼Œç¼©çŸ­ç¼–è¯‘é“¾è·¯

**æ–¹æ¡ˆ**ï¼š
```
workspace/
â”œâ”€â”€ Cargo.toml                    # workspace é…ç½®
â”œâ”€â”€ esp-format-core/              # æ ¸å¿ƒæ ¼å¼è§£æ
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ datatypes.rs
â”‚   â”‚   â”œâ”€â”€ record.rs
â”‚   â”‚   â”œâ”€â”€ group.rs
â”‚   â”‚   â”œâ”€â”€ subrecord.rs
â”‚   â”‚   â””â”€â”€ utils.rs
â”‚   â””â”€â”€ Cargo.toml
â”œâ”€â”€ bethesda-strings/             # å­—ç¬¦ä¸²æ–‡ä»¶å¤„ç†
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ string_file/
â”‚   â”‚   â””â”€â”€ bsa/
â”‚   â””â”€â”€ Cargo.toml
â”œâ”€â”€ esp-extractor/                # ç¿»è¯‘/ç¼–è¾‘å™¨é€»è¾‘
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ plugin/
â”‚   â”‚   â”œâ”€â”€ editor/
â”‚   â”‚   â”œâ”€â”€ localized_context.rs
â”‚   â”‚   â””â”€â”€ string_routes/
â”‚   â””â”€â”€ Cargo.toml
â””â”€â”€ esp-extractor-cli/            # çº¯äºŒè¿›åˆ¶ crate
    â”œï¿½ï¿½ï¿½â”€ src/
    â”‚   â””â”€â”€ main.rs
    â””â”€â”€ Cargo.toml
```

**ä¾èµ–å…³ç³»**ï¼š
```
esp-extractor-cli
    â””â”€â”€ esp-extractor
        â”œâ”€â”€ esp-format-core
        â””â”€â”€ bethesda-strings
            â””â”€â”€ esp-format-core (å¯é€‰)
```

**ä¼˜åŠ¿**ï¼š
- ç‹¬ç«‹ç¼–è¯‘å’Œæµ‹è¯•
- æ¸…æ™°çš„ä¾èµ–è¾¹ç•Œ
- å¯ä»¥å•ç‹¬å‘å¸ƒ crate
- å‡å°‘ç¼–è¯‘æ—¶é—´

**å®æ–½æ­¥éª¤**ï¼š
1. åˆ›å»º workspace Cargo.toml
2. åˆ›å»º esp-format-core crate
3. åˆ›å»º bethesda-strings crate
4. é‡æ„ esp-extractor ä¾èµ–æ–° crate
5. åˆ›å»º esp-extractor-cli
6. æ›´æ–°æ–‡æ¡£å’Œç¤ºä¾‹
7. å…¨é¢æµ‹è¯•

## å®æ–½ä¼˜å…ˆçº§

### âœ… å·²å®Œæˆï¼ˆ2025-11-26ï¼‰
- [x] P0: æ–‡æ¡£ä¿®æ­£
- [x] P1: CLI å‡çº§
- [x] P2.1: æ‹†åˆ† plugin.rs (1264 è¡Œ â†’ 7 ä¸ªæ–‡ä»¶)
- [x] P2.2: æ‹†åˆ† string_file.rs (1119 è¡Œ â†’ 6 ä¸ªæ–‡ä»¶)
- [x] P2.3: æå–å­—ç¬¦ä¸²è·¯ç”±æ¨¡å—
- [x] P2.4: å®ç° IO æŠ½è±¡å±‚æ³¨å…¥

### å¾…å®æ–½ï¼ˆç•™ç»™ä¸‹ä¸€ä¸ª sessionï¼‰
- [ ] P3: è§„åˆ’å¹¶å®æ–½ workspace ç»“æ„

## P2 é‡æ„æ€»ç»“

### ğŸ“Š é‡æ„ç»Ÿè®¡
- **æ¨¡å—æ‹†åˆ†**: 2ä¸ªå¤§æ–‡ä»¶ â†’ 13ä¸ªå°æ–‡ä»¶ï¼ˆplugin: 7ä¸ªï¼Œstring_file: 6ä¸ªï¼‰
- **ä»£ç è¡Œæ•°**: 2383 è¡Œ â†’ åˆ†æ•£åˆ° 13 ä¸ªæ–‡ä»¶ï¼ˆå¹³å‡ ~183 è¡Œ/æ–‡ä»¶ï¼‰
- **æ–°å¢æ¨¡å—**: string_routesï¼ˆ3ä¸ªæ–‡ä»¶ï¼‰
- **æµ‹è¯•é€šè¿‡ç‡**: 54/54 åº“æµ‹è¯•ï¼Œ9/10 é›†æˆæµ‹è¯•

### âœ… æ¶æ„æ”¹è¿›
1. **èŒè´£åˆ†ç¦»**: æ¯ä¸ªæ¨¡å—è´Ÿè´£ç‰¹å®šåŠŸèƒ½
2. **ä¾èµ–å€’ç½®**: æ ¸å¿ƒé€»è¾‘ä¾èµ–æŠ½è±¡æ¥å£
3. **æ˜“äºæ‰©å±•**: StringRouter å’Œ IO å±‚å¯è‡ªå®šä¹‰
4. **å‘åå…¼å®¹**: æ—§ä»£ç æ— éœ€ä¿®æ”¹

### ğŸ¯ æŠ€æœ¯å€ºåŠ¡æ¸…ç†
- âœ… æ¶ˆé™¤äº† `string_records` å­—æ®µçš„ç›´æ¥ä¾èµ–ï¼ˆä½¿ç”¨è·¯ç”±å™¨ï¼‰
- âœ… æ¶ˆé™¤äº† `std::fs` çš„ç›´æ¥ä¾èµ–ï¼ˆä½¿ç”¨ IO traitï¼‰
- âœ… ä¿æŒäº†æ€§èƒ½ä¼˜åŒ–ï¼ˆmemmap ç­‰ï¼‰
- âœ… ä¿æŒäº†å‘åå…¼å®¹æ€§

## æµ‹è¯•ç­–ç•¥

æ¯ä¸ªé‡æ„æ­¥éª¤åå¿…é¡»ï¼š
1. è¿è¡Œ `cargo test` ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡
2. è¿è¡Œ `cargo clippy` æ£€æŸ¥ä»£ç è´¨é‡
3. è¿è¡Œ `cargo build --release --features cli` éªŒè¯ CLI
4. æ‰‹åŠ¨æµ‹è¯•å…³é”®åŠŸèƒ½ï¼ˆæå–ã€åº”ç”¨ç¿»è¯‘ã€ESL è½¬æ¢ï¼‰

## å›æ»šè®¡åˆ’

å¦‚æœé‡æ„å¯¼è‡´é—®é¢˜ï¼š
1. ä½¿ç”¨ git å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬
2. åˆ›å»ºæ–°åˆ†æ”¯è¿›è¡Œé‡æ„
3. é€šè¿‡ PR å®¡æŸ¥åå†åˆå¹¶

## æ³¨æ„äº‹é¡¹

1. **ä¿æŒå‘åå…¼å®¹**ï¼šå…¬å…± API ä¸åº”æœ‰ç ´åæ€§å˜æ›´
2. **æ¸è¿›å¼é‡æ„**ï¼šæ¯æ¬¡åªæ”¹ä¸€ä¸ªæ¨¡å—ï¼Œç¡®ä¿ç¨³å®š
3. **æ–‡æ¡£åŒæ­¥æ›´æ–°**ï¼šä»£ç ç»“æ„å˜åŒ–åæ›´æ–° ARCHITECTURE.md
4. **æ€§èƒ½ç›‘æ§**ï¼šé‡æ„ä¸åº”é™ä½æ€§èƒ½ï¼Œå¿…è¦æ—¶æ·»åŠ  benchmark

## å‚è€ƒèµ„æ–™

- [Rust API Guidelines](https://rust-lang.github.io/api-guidelines/)
- [SOLID åŸåˆ™åœ¨ Rust ä¸­çš„åº”ç”¨](https://doc.rust-lang.org/book/)
- [Cargo Workspace æ–‡æ¡£](https://doc.rust-lang.org/cargo/reference/workspaces.html)
